#!/usr/bin/env perl

use strict;
use warnings;

use List::Util 'max';

use autodie;

use Net::Twitter;

my $nt = Net::Twitter->new(
    traits => [qw/API::RESTv1_1/],
    ssl => 1,
);

use Data::Dumper::Concise;
my $user = 'thegrugq';

my @in = (
    screen_name => $user,
    trim_user => 1,
    exclude_replies => 1,
    count => 200,
);
my @statuses = sort { $a->{id} cmp $b->{id} } @{$nt->user_timeline({@in})};
_save($user, \@statuses);

# 1000 or 2 weeks
while (@statuses < 1000) {
    my @new_statuses =
        @{$nt->user_timeline({
            @in,
            max_id => $statuses[0]->{id},
        })};
    @statuses = (@new_statuses, @statuses);
    my %statuses = map { $_->{id} => $_ } @statuses;
    @statuses =
        sort { $a->{id} cmp $b->{id} }
        values %statuses;
    _save($user, \@statuses);
}

sub _save {
    my ($user, $data) = @_;
    my $name = "$user-statuses";
    open my $fh, '>', "$name.tmp";
    print $fh Dumper($data);
    rename "$name.tmp", $name;
}

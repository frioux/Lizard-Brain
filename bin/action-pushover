#!/usr/bin/env perl

use strict;
use warnings;

use HTTP::Tiny;
use HTTP::Request::Common;

my $ua = HTTP::Tiny->new( verify_SSL => 1 );

my $res = send_message();

if ($res->{status} == 500) {
   my $max_retries = 20;
   while ($res->{status} == 500 && $max_retries--) {
      sleep 5;
      send_message();
   }
}

sub send_message {
   $ua->request(
      POST 'https://api.pushover.net/1/messages.json' => {
         token   => $ENV{PUSHOVER_API},
         user    => $ENV{PUSHOVER_USER},
         message => ($ENV{LB_REMINDER}||join ' ', @ARGV),
      },
   )
}

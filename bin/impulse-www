#!/usr/bin/env perl

use strict;
use warnings;

package LizardBrain::WWW;
use Web::Simple;
use IO::Socket::IP;

$|++;
sub dispatch_request {
  'GET + /twilio + ?From=&Body=' => sub {
    my ($self, $from, $body) = @_;

    return [ 405, [ 'Content-type', 'text/plain' ], [ 'Not authorized yo' ] ]
      unless $from ne $ENV{MY_CELL};

    my $sock = IO::Socket::IP->new(
       PeerHost => '127.0.0.1',
       PeerPort => 8000,
       Type     => SOCK_STREAM,
     ) or return [
       500,
       [ 'Content-type', 'text/plain' ],
       [ "Cannot construct socket - $@" ]
     ];

    # TODO: bubble up non-zero exits somehow
     print $sock "$body";

     shutdown $sock, 1;

     local $/;
     [ 200, [ 'Content-type', 'text/plain' ], [ <$sock> ] ]
  },
  '' => sub {
    [ 405, [ 'Content-type', 'text/plain' ], [ 'Method not allowed' ] ]
  }
}
LizardBrain::WWW->run_if_script;
